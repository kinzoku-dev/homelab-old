---
- hosts: "{{ hosts }}"
  tasks:
    - name: create remote project dir
      shell: |
        mkdir -p {{ remote_project_dir }}

    - name: copy docker-compose file
      copy:
        src: "{{ local_project_dir }}/{{ item }}"
        dest: "{{ remote_project_dir }}/{{ item }}"
      loop:
        - docker-compose.yaml

    - name: copy .env file if needed
      when: copy_env is defined and copy_env == "true"
      copy:
        src: "{{ local_project_dir }}/{{ item }}"
        dest: "{{ remote_project_dir }}/{{ item }}"
      loop:
        - .env

    - name: copy other files
      when: extra_files is defined
      copy:
        src: "{{ local_project_dir }}/{{ item }}"
        dest: "{{ remote_project_dir }}/{{ item }}"
      loop: "{{ extra_files }}"

    - name: copy other folders
      when: extra_folders is defined
      block:
        - name: create src folders if needed
          shell: |
            mkdir -p {{ remote_project_dir }}/{{ item.dest }} -m 777
          loop: "{{ extra_folders }}"
          when: item.dest is defined
        - name: copy folders
          copy:
            src: "{{ local_project_dir }}/{{ item.src }}"
            dest: "{{ remote_project_dir }}/{{ item.dest | default('') }}"
          loop: "{{ extra_folders }}"

    - name: deploy docker-compose project
      community.docker.docker_compose_v2:
        project_src: "{{ remote_project_dir }}"
        files:
          - docker-compose.yaml
        state: present
        pull: policy
        remove_orphans: true
        recreate: always
